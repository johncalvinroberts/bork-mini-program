<style lang="scss">
@import '../styles/mixins.scss';
  .registration--title {
    @include titletext;
  }

  .registration--subtitle {
    @include subtitletext;
  }
</style>
<template>
  <view class="container padbox--default">
    <view class="registration--title">æˆä¸ºrescuer</view>
    <view class="registration--subtitle">Are you a compassionate person? Do you come close to tears at the thought of a poor dog being neglected, abused, abandoned or even eaten? Do you collect stray dogs and/or cats and have more of them than you can handle? If so, become a rescuer and find a new home for your little bundles of love.
    </view>
    <formparent>
      <button class="btn--default__dark" disabled="{{wechatDisabled}}" @tap="getWeChat">
        <image class="icon--inline" src="../icons/wechat_white.svg" mode="aspectFit"></image>
        ä½¿ç”¨å¾®ä¿¡ç™»å½•
      </button>
      <block wx:if="{{authData}}">
        <view class="form--group">
          <view class="form--group__title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="form-item--default">
            <view class="form-item--label">åå­—</view>
            <view class="form-item--input">{{authData.nickName}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">åœ°æ–¹</view>
            <view class="form-item--input">{{authData.province}}, {{authData.city}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">å¾®ä¿¡ğŸ‘Œ</view>
            <input type="text" placeholder="è¯·è¾“å…¥ä½ çš„å¾®ä¿¡å·" class="form-item--input" @blur="handleWx" maxlength="70" confirm-type="next" value="{{wxUsername || ''}}"/>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">å¹´é¾„ğŸ«</view>
            <input type="number" placeholder="è¾“å…¥ä½ çš„å¹´é¾„è¯·" class="form-item--input" @blur="handleAge" maxlength="3" confirm-type="next" value="{{age || ''}}"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">è‡ªæˆ‘ä»‹ç»</view>
          <view class="form-item--label">ä»‹ç»ä¸€ä¸‹è‡ªå·±ï¼Œè¯´ä¸€è¯´ä½ æ¥è¿™é‡Œçš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Œä½ å¯¹ä½ çš„rescue dog å’Œ rescue cat æœ‰å¤šä¹ˆå¤šä¹ˆçš„çˆ±ï¼Œç­‰ç­‰</view>
          <view class="form-item--default">
            <textarea class="form-item--textinput" @blur="handlePersonal" confirm-type="next" maxlength="200" value="{{personalNote}}"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">èº«ä»½ä¿¡æ¯</view>
          <view class="form-item--label">For Your Safety</view>
          <view class="form-item--default">
            <radiolist @toggle.user="toggleIdType" :choices.sync="idChoices" :currentchoice.sync="idType"/>
          </view>
          <block wx:if="{{chooseChineseId}}">
            <view class="form-item--default">
              <view class="form-item--label">
                èº«ä»½è¯ğŸ“‡
              </view>
              <input type="idcard" placeholder="èº«ä»½è¯" class="form-item--input" @blur="handleId" confirm-type="next"/>
            </view>
          </block>
            <block wx:else>
              <view class="form-item--default">
                <view class="form-item--label__fullwidth">
                  <coolpicker @change.user="handleCountryChange" :collection.sync="countryChoices" :selection.sync="country" :label.sync="countryText"/>
                </view>
              </view>
              <view class="form-item--default">
                <view class="form-item--label">
                  å§“åğŸ“‡
                </view>
                <input type="text" placeholder="è¯·è¾“å…¥ä½ çš„å…¨æ³•å¾‹ä¸Šçš„å§“å" class="form-item--input" @blur="handleFullName" maxlength="50" confirm-type="next" value="{{fullName || ''}}"/>
              </view>
              <view class="form-item--default">
                <view class="form-item--label">
                  æŠ¤ç…§ğŸ›‚
                </view>
                <input type="number" placeholder="è¯·è¾“å…¥æŠ¤ç…§å·" class="form-item--input" @blur="handleId" maxlength="50" confirm-type="next" value="{{idNumber || ''}}"/>
              </view>
          </block>
        </view>
        <button class="btn--default" @tap="handleSubmit">ä¿å­˜</button>
      </block>
    </formparent>
  </view>
  <redirectmodal/>
  <errormodal/>
  <fidoloader/>
</template>
<script>
  import wepy from 'wepy'
  import FormParent from '@/components/form-parent'
  import RedirectModal from '@/components/redirect-modal'
  import ErrorModal from '@/components/error-modal'
  import CoolPicker from '@/components/cool-picker'
  import RadioList from '@/components/radiolist'
  import FidoLoader from '@/components/fido-loader'
  import countryChoices from '@/utils/countries'
  import isEmpty from 'lodash.isempty'

  export default class RescuerRegistration extends wepy.page {
    data = {
      idChoices: [{
        name: 'èº«ä»½è¯',
        value: 'chinese_id'
      }, {
        name: 'æŠ¤ç…§',
        value: 'passport'
      }],
      countryChoices: countryChoices,
      countryText: 'æŠ¤ç…§å›½å®¶ ğŸ',
      authData: null,
      wxUsername: null,
      personalNote: null,
      age: null,
      idNumber: '',
      idType: 'chinese_id',
      country: 'China',
      fullName: ''
    }

    components = {
      formparent: FormParent,
      redirectmodal: RedirectModal,
      errormodal: ErrorModal,
      coolpicker: CoolPicker,
      radiolist: RadioList,
      fidoloader: FidoLoader
    }

    computed = {
      wechatDisabled () {
        return this.authData !== null
      },
      chooseChineseId () {
        return this.idType === 'chinese_id'
      },
      hasEmptyFields () {
        const {age, wxUsername, personalNote, idNumber, country, fullName} = this.data
        const fields = {age, wxUsername, personalNote, idNumber}
        if (this.idType === 'passport') {
          fields.country = country
          fields.fullName = fullName
        }
        const emptyFields = Object.keys(fields).filter(field => {
          let value = fields[field]
          if (value === '' || value === ' ' || value === null) {
            return field
          }
        })
        return isEmpty(emptyFields) ? false : emptyFields
      }
    }

    methods = {
      handleWx ({detail}) {
        this.wxUsername = detail.value
        this.$apply()
      },
      handlePersonal ({detail}) {
        this.personalNote = detail.value
        this.$apply()
      },
      handleAge ({detail}) {
        this.age = detail.value
        this.$apply()
      },
      handleId ({detail}) {
        console.log('heyoay')
        this.idNumber = detail.value
        this.$apply()
      },
      handleFullName ({detail}) {
        this.fullName = detail.value
        this.$apply()
      },
      toggleIdType (e) {
        if (this.idType === 'chinese_id') {
          this.idType = 'passport'
        } else {
          this.idType = 'chinese_id'
        }
        this.idNumber = ''
        this.$apply()
      },
      handleCountryChange ({detail}) {
        this.country = countryChoices[detail.value]
        this.$apply()
      },
      reloadPage () {
        this.onLoad()
      }
    }

    onload () {}

    onShow () {
      this.isRegistered = this.$parent.globalData.user.isRegistered
      this.authData = this.$parent.globalData.user.attributes
      if (this.authData) this.diffAuthData()
      if (this.$parent.globalData.user.isRescuer) {
        const params = {
          message: 'ä½ å·²ç»æ˜¯rescueräº†ï¼Œä½ å¯ä»¥åœ¨ä¸ªäººä¸­å¿ƒç¼–è¾‘ä½ çš„èµ„æ–™',
          link: 'edit-profile',
          linkname: 'ç¼–è¾‘'
        }
        this.$invoke('redirectmodal', 'toggleModal', params)
      }
    }

    async getWeChat () {
      this.$invoke('fidoloader', 'showLoading', '')
      const user = this.$parent.globalData.user
      try {
        await user.authorize()
        this.authData = this.$parent.globalData.user.attributes
        this.$apply()
        this.diffAuthData()
        this.$invoke('fidoloader', 'hideLoading', '')
      } catch (err) {
        this.$invoke('fidoloader', 'hideLoading', '')
        // actually deal with the error maybe lol
        console.error(err)
        this.handleFetchError()
      }
    }

    handleFetchError () {
      const params = {
        header: 'å“å“Ÿå‡ºé”™äº†ğŸ˜¯',
        message: 'åˆ·æ–°é¡µé¢å†è¯•è¯•ä¸€é',
        refresh: true
      }
      this.$invoke('errormodal', 'showMessage', params)
    }

    async handleSubmit () {
      if (this.hasEmptyFields) return this.handleSubmitError()
      this.$invoke('fidoloader', 'showLoading', '')
      try {
        const {wxUsername, personalNote, age, idType, idNumber, fullName, country} = this.data
        await this.$parent.globalData.user.updateProfileInfo({wxUsername, personalNote, age, idType, idNumber, fullName, country})
        const params = {message: 'æ­å–œä½ , ä½ å·²ç»æˆä¸ºfidoçš„rescuer'}
        this.$invoke('fidoloader', 'hideLoading', '')
        this.$invoke('redirectmodal', 'toggleModal', params)
        this.$parent.globalData.user.fetchUpdate()
      } catch (err) {
        console.error(err)
        this.handleFetchError()
      }
    }

    handleSubmitError () {
      const params = {
        header: 'è®¤è¯å¤±è´¥ ğŸ™‡â€',
        message: `ä½ è¿˜æ²¡æœ‰å¡«å®Œä½ çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¸ºäº†ä½ çš„å®‰å…¨åŠªåŠ›ï¼Œè¯·å¡«å®Œå†æäº¤è°¢è°¢ğŸ™`
      }
      return this.$invoke('errormodal', 'showMessage', params)
    }

    diffAuthData () {
      this.age = this.authData.age || ''
      this.personalNote = this.authData.personalNote || ''
      this.wxUsername = this.authData.wxUsername || ''
      this.idNumber = this.authData.idNumber || ''
      this.country = this.authData.country || 'china'
      this.idType = this.authData.idType || 'chinese_id'
      this.$apply()
    }
  }
</script>
