<style lang="scss">
@import '../styles/mixins.scss';
  .registration--title {
    @include titletext;
  }

  .registration--subtitle {
    @include subtitletext;
  }
</style>
<template>
  <view class="container padbox--default">
    <view class="registration--title">æˆä¸ºrescuer</view>
    <view class="registration--subtitle">Are you a compassionate person? Do you come close to tears at the thought of a poor dog being neglected, abused, abandoned or even eaten? Do you collect stray dogs and/or cats and have more of them than you can handle? If so, become a rescuer and find a new home for your little bundles of love.
    </view>
    <formparent>
      <button class="btn--default__dark" disabled="{{wechatDisabled}}" @tap="getWeChat">
        <image class="icon--inline" src="../icons/wechat_white.svg" mode="aspectFit"></image>
        ä½¿ç”¨å¾®ä¿¡ç™»å½•
      </button>
      <block wx:if="{{authData}}">
        <view class="form--group">
          <view class="form--group__title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="form-item--default">
            <view class="form-item--label">åå­—</view>
            <view class="form-item--input">{{authData.nickName}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">åœ°æ–¹</view>
            <view class="form-item--input">{{authData.province}}, {{authData.city}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">å¾®ä¿¡ğŸ‘Œ</view>
            <input type="text" placeholder="è¯·è¾“å…¥ä½ çš„å¾®ä¿¡å·" class="form-item--input" @input="handleWx" maxlength="70" confirm-type="next" value="{{authData.wechatId || ''}}"/>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">å¹´é¾„ğŸ«</view>
            <input type="number" placeholder="è¾“å…¥ä½ çš„å¹´é¾„è¯·" class="form-item--input" @input="handleAge" maxlength="3" confirm-type="next" value="{{authData.age || ''}}"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">è‡ªæˆ‘ä»‹ç»</view>
          <view class="form-item--label">ä»‹ç»ä¸€ä¸‹è‡ªå·±ï¼Œè¯´ä¸€è¯´ä½ æ¥è¿™é‡Œçš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Œä½ å¯¹ä½ çš„rescue dog å’Œ rescue cat æœ‰å¤šä¹ˆå¤šä¹ˆçš„çˆ±ï¼Œç­‰ç­‰</view>
          <view class="form-item--default">
            <textarea class="form-item--textinput" @input="handlePersonal" confirm-type="next" maxlength="200" value="{{authData.personalNote}}"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">èº«ä»½ä¿¡æ¯</view>
          <view class="form-item--label">For Your Safety</view>
          <view class="form-item--default">
            <radiolist @toggle.user="toggleIdType" :choices.sync="idChoices" :currentchoice.sync="idType"/>
          </view>
          <block wx:if="{{chooseChineseId}}">
            <view class="form-item--default">
              <view class="form-item--label">
                èº«ä»½è¯ğŸ“‡
              </view>
              <input type="idcard" placeholder="èº«ä»½è¯" class="form-item--input" @input="handleId" maxlength="3" confirm-type="next"/>
            </view>
          </block>
            <block wx:else>
              <view class="form-item--default">
                <view class="form-item--label__fullwidth">
                  <coolpicker @change.user="handleCountryChange" :collection.sync="countryChoices" :selection.sync="country" :label.sync="countryText"/>
                </view>
              </view>
              <view class="form-item--default">
                <view class="form-item--label">
                  å§“åğŸ“‡
                </view>
                <input type="number" placeholder="è¯·è¾“å…¥ä½ çš„å…¨æ³•å¾‹ä¸Šçš„å§“å" class="form-item--input" @input="handleFullName" maxlength="50" confirm-type="next" value="{{authData.fullName || ''}}"/>
              </view>
              <view class="form-item--default">
                <view class="form-item--label">
                  æŠ¤ç…§ğŸ›‚
                </view>
                <input type="number" placeholder="è¯·è¾“å…¥æŠ¤ç…§å·" class="form-item--input" @input="handleId" maxlength="50" confirm-type="next"/>
              </view>
          </block>
        </view>
        <button class="btn--default" @tap="handleSubmit">ä¿å­˜</button>
      </block>
    </formparent>
  </view>
  <redirectmodal/>
  <errormodal/>
</template>
<script>
  import wepy from 'wepy'
  import FormParent from '@/components/form-parent'
  import RedirectModal from '@/components/redirect-modal'
  import ErrorModal from '@/components/error-modal'
  import CoolPicker from '@/components/cool-picker'
  import RadioList from '@/components/radiolist'
  import countryChoices from '@/utils/countries'

  import isEmpty from 'lodash.isempty'

  export default class RescuerRegistration extends wepy.page {
    data = {
      idChoices: [{
        name: 'èº«ä»½è¯',
        value: 'chinese_id'
      }, {
        name: 'æŠ¤ç…§',
        value: 'passport'
      }],
      countryChoices: countryChoices,
      countryText: 'æŠ¤ç…§å›½å®¶ ğŸ',
      authData: null,
      wxUsername: null,
      personalNote: null,
      age: null,
      idNumber: null,
      idType: 'chinese_id',
      country: 'China',
      fullName: ''
    }

    components = {
      formparent: FormParent,
      redirectmodal: RedirectModal,
      errormodal: ErrorModal,
      coolpicker: CoolPicker,
      radiolist: RadioList
    }

    computed = {
      wechatDisabled () {
        return this.authData !== null
      },
      chooseChineseId () {
        return this.idType === 'chinese_id'
      },
      checkFields () {
        const fields = [this.age, this.wxUsername, this.personalNote, this.idNumber]
        if (this.idType === 'passport') {
          fields.push(this.country, this.fullName)
        }
        const emptyFields = fields.filter(field => isEmpty(field))
        if (isEmpty(emptyFields)) return emptyFields
        return false
      }
    }

    methods = {
      handleWx ({detail}) {
        this.wxUsername = detail.value
        this.$apply()
      },
      handlePersonal ({detail}) {
        this.personalNote = detail.value
        this.$apply()
      },
      handleAge ({detail}) {
        this.age = detail.value
        this.$apply()
      },
      handleId ({detail}) {
        this.idNumber = detail.value
        this.$apply()
      },
      handleFullName ({detail}) {
        this.fullName = detail.value
      },
      toggleIdType (e) {
        if (this.idType === 'chinese_id') {
          this.idType = 'passport'
        } else {
          this.idType = 'chinese_id'
        }
      },
      handleCountryChange ({detail}) {
        this.country = countryChoices[detail.value]
        this.$apply()
      },
      reloadPage () {
        this.onLoad()
      },
      handleSubmit () {
        const emptyFields = this.checkFields
        if (emptyFields) {
          console.log(emptyFields)
        }
      }
    }

    onload () {}

    onShow () {
      this.isRegistered = this.$parent.globalData.user.isRegistered
      this.authData = this.$parent.globalData.user.attributes
      if (this.authData) this.diffAuthData()
      console.log(this.isRegistered)
      if (this.$parent.globalData.user.isRescuer) {
        const params = {
          message: 'ä½ å·²ç»æ˜¯rescueräº†ï¼Œä½ å¯ä»¥åœ¨ä¸ªäººä¸­å¿ƒç¼–è¾‘ä½ çš„èµ„æ–™',
          link: 'edit-profile',
          linkname: 'ç¼–è¾‘'
        }
        this.$invoke('redirectmodal', 'toggleModal', params)
      }
    }

    async getWeChat () {
      const user = this.$parent.globalData.user
      try {
        await user.authorize()
        this.authData = this.$parent.globalData.user.currentUser()
        this.$apply()
      } catch (err) {
        // actually deal with the error maybe lol
        console.error(err)
      }
    }
    diffAuthData () {
      this.age = this.authData.age
      this.personalNote = this.authData.personalNote
      this.wxUsername = this.authData.wxUsername
      this.$apply()
    }
  }
</script>
