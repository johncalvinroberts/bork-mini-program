<template>
  <view class="container padbox--default">
    <view class="registration--title">{{t.title}}</view>
    <view class="registration--subtitle">{{t.subtitle}}
    </view>
    <formparent>

      <button class="btn--default__dark" disabled="{{wechatDisabled}}" @tap="getWeChat">
        <image class="icon--inline" src="../icons/wechat_white.svg" mode="aspectFit"></image>
        {{t.login_with_wechat}}
      </button>
      <block wx:if="{{authData}}">
        <view class="form--group">
          <view class="form--group__title">{{t.basic_info}}</view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.name}}</view>
            <view class="form-item--input">{{authData.nickName}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.place}}</view>
            <view class="form-item--input">{{authData.province}}, {{authData.city}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.wechat}}</view>
            <input type="text" placeholder="è¯·è¾“å…¥ä½ çš„å¾®ä¿¡å·" class="form-item--input" @blur="handleWx" maxlength="70" confirm-type="next"/>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.age}}</view>
            <input type="number" placeholder="è¾“å…¥ä½ çš„å¹´é¾„è¯·" class="form-item--input" @blur="handleAge" maxlength="3" confirm-type="next"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">{{t.self_intro}}</view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.intro_explanation}}</view>
            <textarea class="form-item--textinput" @focus="handleFocus" @blur="handlePersonal" confirm-type="send" @confirm="handleSubmit" maxlength="200" />
          </view>
        </view>
        <button class="btn--default" @tap="handleSubmit">{{t.save}}</button>
      </block>
    </formparent>
  </view>
  <redirectmodal/>
  <errormodal/>
  <fidoloader/>
</template>
<script>
  import wepy from 'wepy'
  import FormParent from '@/components/form-parent'
  import RedirectModal from '@/components/redirect-modal'
  import ErrorModal from '@/components/error-modal'
  import FidoLoader from '@/components/fido-loader'
  import LocalesMixin from '@/mixins/localesmixin'

  export default class Registration extends wepy.page {
    config = {
      navigationBarTitleText: 'æ³¨å†Œ'
    }

    components = {
      formparent: FormParent,
      redirectmodal: RedirectModal,
      errormodal: ErrorModal,
      fidoloader: FidoLoader
    }

    mixins = [LocalesMixin]

    data = {
      isRegistered: false,
      authData: null,
      wxUsername: {},
      personalNote: null,
      age: null
    }

    methods = {
      redirectHome () {
        wepy.navigateTo({url: 'landing'})
      },
      handleWx ({detail}) {
        this.wxUsername = detail.value
        this.$apply()
      },
      handlePersonal ({detail}) {
        this.personalNote = detail.value
        this.$apply()
      },
      handleAge ({detail}) {
        this.age = detail.value
        this.$apply()
      }
    }

    computed = {
      fieldsValid () {
        if (!this.personalNote || !this.wxUsername || !this.age) {
          return false
        }
        return true
      },
      wechatDisabled () {
        return this.authData !== null
      }
    }

    onLoad () {
      this.isRegistered = this.$parent.globalData.user.isRegistered
      if (this.isRegistered) {
        const params = {message: 'ä½ å·²ç»æ³¨å†Œäº†'}
        this.$invoke('redirectmodal', 'toggleModal', params)
      }
    }

    async getWeChat () {
      const user = this.$parent.globalData.user
      this.$invoke('fidoloader', 'showLoading', '')
      try {
        await user.authorize()
        this.authData = this.$parent.globalData.user.currentUser()
        this.$apply()
        this.$invoke('fidoloader', 'hideLoading', '')
      } catch (err) {
        // actually deal with the error maybe lol
        console.error(err)
        this.$invoke('fidoloader', 'hideLoading', '')
        this.handleFetchError()
      }
    }

    async handleSubmit () {
      if (!this.fieldsValid) {
        return this.handleSubmitError()
      }
      try {
        this.$invoke('fidoloader', 'showLoading', '')
        const {wxUsername, personalNote, age} = this.data
        await this.$parent.globalData.user.updateProfileInfo({wxUsername, personalNote, age})
        const params = {message: 'æ­å–œä½ æ³¨å†ŒæˆåŠŸäº†'}
        this.$invoke('fidoloader', 'hideLoading', '')
        this.$invoke('redirectmodal', 'toggleModal', params)
        this.$parent.globalData.user.fetchUpdate()
      } catch (err) {
        // this error too my guy
        console.error(err)
        this.handleFetchError()
      }
    }

    handleFetchError () {
      const params = {
        header: 'å“å“Ÿå‡ºé”™äº†ğŸ˜¯',
        message: 'åˆ·æ–°é¡µé¢å†è¯•è¯•ä¸€é',
        refresh: true
      }
      this.$invoke('errormodal', 'showMessage', params)
    }

    handleSubmitError () {
      const header = 'è®¤è¯å¤±è´¥ ğŸ™‡â€'
      const message = 'ä½ å¾—æä¾›ä½ çš„ä¸ªäººèµ„æ–™æ‰æœ‰æƒåˆ©é¢†å…»æ— å®¶å¯å½’çš„å°åŠ¨ç‰©ã€‚'
      const params = {
        header,
        message
      }
      return this.$invoke('errormodal', 'showMessage', params)
    }
  }
  </script>
